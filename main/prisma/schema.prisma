generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  EDITOR
  CLIENT
}

enum LeadType {
  CONTACT
  QUOTE
}

enum LeadStatus {
  NEW
  IN_REVIEW
  IN_PROGRESS
  CLOSED
}

model User {
  id                 String     @id @default(cuid())
  email              String     @unique
  name               String?
  role               Role       @default(EDITOR)
  passwordHash       String
  mfaEnabled         Boolean    @default(false)
  mfaSecretEncrypted String?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  lastLoginAt        DateTime?
  disabled           Boolean    @default(false)
  auditLogs          AuditLog[]

  @@index([role])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action    String
  entityType String?
  entityId  String?
  metaJson  Json?
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
}

model Lead {
  id              String     @id @default(cuid())
  type            LeadType
  name            String
  email           String
  phone           String?
  message         String?
  serviceInterest String?
  attachments     Json?
  status          LeadStatus @default(NEW)
  notes           String?
  createdAt       DateTime   @default(now())

  @@index([type])
  @@index([status])
}

model Service {
  id               String   @id @default(cuid())
  slug             String   @unique
  title            String
  excerpt          String?
  contentBlocksJson Json
  faqsJson         Json
  icon             String?
  order            Int      @default(0)
  published        Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([published])
  @@index([order])
}

model Post {
  id            String   @id @default(cuid())
  slug          String   @unique
  title         String
  excerpt       String?
  body          String
  tags          String[] @default([])
  featuredImage String?
  published     Boolean  @default(false)
  publishedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([published])
  @@index([publishedAt])
}

model Page {
  id        String   @id @default(cuid())
  slug      String   @unique
  title     String
  blocksJson Json
  published Boolean  @default(false)
  updatedAt DateTime @updatedAt

  @@index([published])
}

model Media {
  id        String   @id @default(cuid())
  key       String   @unique
  url       String
  filename  String
  mime      String
  size      Int
  alt       String?
  tags      String[] @default([])
  createdAt DateTime @default(now())
}

model SiteSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  valueJson Json
  updatedAt DateTime @updatedAt
}

model InviteToken {
  id          String   @id @default(cuid())
  email       String
  role        Role     @default(ADMIN)
  tokenHash   String   @unique
  expiresAt   DateTime
  usedAt      DateTime?
  createdById String?
  createdAt   DateTime @default(now())

  createdBy   User?    @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([expiresAt])
}
